name: Update READMEs

on:
  push:
    branches:
      - **  # triggers when something is merged into main
  workflow_dispatch: # allows manual trigger

jobs:
  update-readmes:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2️⃣ Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: lts/*

      # 3️⃣ Install pnpm
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      # 4️⃣ Install dependencies
      - name: Install dependencies
        run: pnpm install

      # 5️⃣ Generate READMEs
      - name: Update README.md from demos
        run: pnpm ts-node demo/update-readmes.ts

      # 6️⃣ Check if any README changed
      - name: Check for changes
        id: check_changes
        run: |
          git config user.name "CI Bot"
          git config user.email "ci@example.com"
          git add '**/readme.md'
          if git diff --cached --quiet; then
            echo "no_changes=true" >> $GITHUB_OUTPUT
          else
            echo "no_changes=false" >> $GITHUB_OUTPUT
          fi

      # 7️⃣ Create a PR only if there are changes
      - name: Create pull request for updated READMEs
        if: steps.check_changes.outputs.no_changes == 'false'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Update README.md from demos"
          branch: "update-readmes/${{ github.run_id }}"
          title: "Update README.md from demos"
          body: "This PR updates generated README.md files from demo scripts."
          base: main